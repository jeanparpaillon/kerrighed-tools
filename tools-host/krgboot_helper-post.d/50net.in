#!/bin/sh

set -e

IP=/bin/ip
SED=/bin/sed
PID=$1

session_id=$(cat /sys/kerrighed/session_id)
node_id=$(cat /sys/kerrighed/node_id)

. @sysconfdir@/kerrighed/net.conf

[ "$NETCONF_ENABLE" = true ] || exit 0

mac=${VIRTMAC%:*}:$(printf %02x $node_id)
# Reserve room for the 802.1q header
mtu=$($IP link show $PHYS | $SED -n 's/^.* mtu \([0-9]*\) .*$/\1/p')
mtu=$(( $mtu - 4 ))

$IP link add link $PHYS address $mac $VIRT type macvlan
$IP link set $VIRT mtu $mtu
$IP link set $VIRT netns $PID

echo $VIRT > /var/run/kerrighed/net-conf
