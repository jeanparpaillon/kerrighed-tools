# =============================================
#            KERNEL PATCH MAKEFILE
#
# Copyright 2006 INRIA-IRISA
# Copyright 2009 Kerlabs
#
# Renaud LOTTIAUX - Paris Research Team - IRISA
# Jean PARPAILLON - Kerlabs
# Erich Focht     - NEC HPCE
#
# $Id: Makefile.am 1007 2006-12-11 10:39:24Z jparpail $
# =============================================
LINUX_VERSION = @COMP_LINUX_VERSION@

srcdir=@srcdir@

KRG_PATCH = $(LINUX_VERSION)/999_kerrighed.patch.bz2
OTHER_PATCHES = $(shell ls $(LINUX_VERSION)/*.bz2 | grep -v '$(KRG_PATCH)')
VANILLA_KERNEL = linux-$(LINUX_VERSION).tar.bz2

MAINTAINER_FILES = \
	Makefile \
	Makefile.in

DISTFILES = $(MAINTAINER_FILES) $(KRG_PATCH) $(OTHER_PATCHES)

all:

dist-patch: $(KRG_PATCH)

$(KRG_PATCH):
	if [ -f /usr/src/$(VANILLA_KERNEL) ]; then \
	    echo "Found vanilla kernel tarball in /usr/src. Linking..." ;\
	    ln -s /usr/src/$(VANILLA_KERNEL) . ;\
	else \
	    echo "Not found vanilla kernel tarball in /usr/src. Downloading..." ;\
	    wget http://ftp.kernel.org/pub/linux/kernel/v2.6/linux-$(LINUX_VERSION).tar.bz2 ; \
	fi
	tar xjf $(VANILLA_KERNEL)
	mv linux-$(LINUX_VERSION) a
	for p in $(OTHER_PATCHES); do \
	    echo "P: Applying patch $$p"; \
	    bunzip2 -c $$p | patch -p1 -d a; \
	done
	rsync -a --exclude '.svn' --exclude '*~' ../kernel ./
	ln -s kernel b
	$(MAKE) -C b mrproper > /dev/null
	diff -Nupr a b | bzip2 > $(KRG_PATCH) || true
	rm -rf a b kernel $(VANILLA_KERNEL)

distdir: $(DISTFILES) clean
	cp -f $(MAINTAINER_FILES) $(distdir)
	mkdir -p $(distdir)/$(LINUX_VERSION)
	cp -f $(KRG_PATCH) $(OTHER_PATCHES) $(distdir)/$(LINUX_VERSION)

install:
	echo "Nothing to install"

uninstall:
	echo "Nothing to uninstall"

clean:
	rm -rf *~ a b kernel linux-$(LINUX_VERSION).tar.bz2

distclean: clean
	rm -r Makefile
	rm -f $(KRG_PATCH)

.PHONY: all dist-patch distdir install clean distclean
