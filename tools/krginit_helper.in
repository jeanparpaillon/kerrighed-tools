#!/bin/sh

set -e

PATH=/sbin:/bin:/usr/sbin:/usr/bin

CONF=@sysconfdir@/kerrighed/krginit_helper.conf
KRG_ROOT=/
# Path inside $KRG_ROOT
KRGINIT=@sbindir@/krginit

error() {
    echo "E: $@"
    exit 1
}

if [ ! -x "$KRG_ROOT$KRGINIT" ]; then
    error "Can not find krginit: $KRG_ROOT$KRGINIT"
fi

. $CONF

# Prefer caller args
if [ $# -gt 0 ]; then
	KRGINIT_ARGS=
fi

mount -t proc krg-procfs $KRG_ROOT/proc

run-parts --verbose --arg=$CONF -- @sysconfdir@/kerrighed/krginit_helper-pre.d

cd  $KRG_ROOT
if [ "$KRG_ROOT" != "/" ]; then
	mount --move . /
fi
eval exec chroot . $KRGINIT -s $KRGINIT_ARGS "$@"
